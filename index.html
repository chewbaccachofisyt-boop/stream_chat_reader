<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream Chat Reader - TTS Web</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .content {
            padding: 30px;
        }

        .section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 1.3em;
            color: #667eea;
            margin-bottom: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .api-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .input-group label {
            font-weight: 600;
            color: #333;
            font-size: 0.95em;
        }

        .input-group input {
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .control-group label {
            font-weight: 600;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .control-group select,
        .control-group input[type="range"] {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
        }

        .control-group input[type="range"] {
            cursor: pointer;
        }

        .slider-value {
            background: #667eea;
            color: white;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.85em;
        }

        .checkbox-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 1em;
        }

        .checkbox-label input {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .btn {
            padding: 18px 30px;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-youtube {
            background: #FF0000;
        }

        .btn-tiktok {
            background: #000000;
        }

        .btn-both {
            background: #10b981;
        }

        .btn-stop {
            background: #ef4444;
        }

        .btn-test {
            background: #8b5cf6;
        }

        .chat-container {
            background: #1e1e1e;
            border-radius: 15px;
            padding: 20px;
            height: 400px;
            overflow-y: auto;
            font-family: 'Consolas', 'Courier New', monospace;
            color: #fff;
        }

        .chat-message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 8px;
            background: rgba(255,255,255,0.05);
            border-left: 4px solid #667eea;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .chat-platform {
            color: #667eea;
            font-weight: bold;
        }

        .chat-youtube {
            border-left-color: #FF0000;
        }

        .chat-twitch {
            border-left-color: #9146FF;
        }
        
        .chat-kick {
            border-left-color: #53FC18;
        }

        .chat-username {
            color: #fbbf24;
            font-weight: bold;
        }

        .chat-text {
            color: #e5e7eb;
            margin-top: 5px;
        }

        .status {
            background: #667eea;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1em;
            margin-top: 20px;
        }

        .status.active {
            background: #10b981;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .info-box {
            background: #fef3c7;
            border: 2px solid #fbbf24;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }

        .info-box h3 {
            color: #92400e;
            margin-bottom: 10px;
        }

        .info-box ul {
            margin-left: 20px;
            color: #78350f;
        }

        .info-box li {
            margin: 5px 0;
        }

        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #2d2d2d;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéôÔ∏è Stream Chat Reader</h1>
            <p>Lee tus chats de YouTube y TikTok en voz alta mientras juegas</p>
        </div>

        <div class="content">
            <!-- Secci√≥n de APIs -->
            <div class="section">
                <div class="section-title">üîë Configuraci√≥n de APIs</div>
                <div class="api-grid">
                    <div class="input-group">
                        <label for="youtubeKey">YouTube API Key</label>
                        <input type="text" id="youtubeKey" placeholder="Ingresa tu API Key de YouTube">
                    </div>
                    <div class="input-group">
                        <label for="tiktokKey">TikTok Username (sin @)</label>
                        <input type="text" id="tiktokKey" placeholder="Ejemplo: tu_usuario">
                    </div>
                    <div class="input-group">
                        <label for="twitchKey">Twitch Username (sin @)</label>
                        <input type="text" id="twitchKey" placeholder="Ejemplo: tu_canal">
                    </div>
                    <div class="input-group">
                        <label for="kickKey">Kick Username (sin @)</label>
                        <input type="text" id="kickKey" placeholder="Ejemplo: tu_canal">
                    </div>
                </div>
            </div>

            <!-- Configuraci√≥n de Voz -->
            <div class="section">
                <div class="section-title">üéµ Configuraci√≥n de Voz</div>
                <div class="controls-grid">
                    <div class="control-group">
                        <label for="voiceSelect">Seleccionar Voz</label>
                        <select id="voiceSelect">
                            <option value="">Cargando voces...</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="volumeSlider">
                            Volumen
                            <span class="slider-value" id="volumeValue">80%</span>
                        </label>
                        <input type="range" id="volumeSlider" min="0" max="100" value="80">
                    </div>
                    <div class="control-group">
                        <label for="speedSlider">
                            Velocidad
                            <span class="slider-value" id="speedValue">1.0x</span>
                        </label>
                        <input type="range" id="speedSlider" min="0.5" max="2" step="0.1" value="1">
                    </div>
                    <div class="control-group">
                        <label for="pitchSlider">
                            Tono
                            <span class="slider-value" id="pitchValue">1.0</span>
                        </label>
                        <input type="range" id="pitchSlider" min="0.5" max="2" step="0.1" value="1">
                    </div>
                </div>

                <div class="checkbox-group" style="margin-top: 20px;">
                    <label class="checkbox-label">
                        <input type="checkbox" id="filterBots" checked>
                        Filtrar mensajes de bots
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="playSound" checked>
                        Sonido de notificaci√≥n
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="showTimestamp" checked>
                        Mostrar hora de mensaje
                    </label>
                </div>
            </div>

            <!-- Botones de Control -->
            <div class="section">
                <div class="section-title">üéÆ Control de Lectura</div>
                <div class="button-grid">
                    <button class="btn btn-youtube" id="btnYoutube">
                        ‚ñ∂Ô∏è YouTube
                    </button>
                    <button class="btn btn-tiktok" id="btnTiktok">
                        ‚ñ∂Ô∏è TikTok
                    </button>
                    <button class="btn btn-twitch" id="btnTwitch" style="background: #9146FF;">
                        ‚ñ∂Ô∏è Twitch
                    </button>
                    <button class="btn btn-kick" id="btnKick" style="background: #53FC18; color: #000;">
                        ‚ñ∂Ô∏è Kick
                    </button>
                    <button class="btn btn-both" id="btnBoth">
                        ‚ñ∂Ô∏è Todos
                    </button>
                    <button class="btn btn-stop" id="btnStop" disabled>
                        ‚èπÔ∏è Detener
                    </button>
                    <button class="btn btn-test" id="btnTest">
                        üîä Probar Voz
                    </button>
                </div>
            </div>

            <!-- Chat en Vivo -->
            <div class="section">
                <div class="section-title">üí¨ Chat en Vivo</div>
                <div class="chat-container" id="chatContainer">
                    <div class="chat-message">
                        <div><span class="chat-platform">[SISTEMA]</span></div>
                        <div class="chat-text">Esperando conexi√≥n... Presiona un bot√≥n para iniciar.</div>
                    </div>
                </div>
            </div>

            <!-- Estado -->
            <div class="status" id="status">
                üü° Estado: Esperando inicio
            </div>

            <!-- Informaci√≥n -->
            <div class="info-box">
                <h3>üìå Instrucciones de Uso:</h3>
                <ul>
                    <li><strong>YouTube:</strong> 
                        <ol style="margin-left: 20px; margin-top: 5px;">
                            <li>Ve a <a href="https://console.cloud.google.com" target="_blank">Google Cloud Console</a></li>
                            <li>Crea un proyecto y habilita "YouTube Data API v3"</li>
                            <li>Crea credenciales (API Key) y p√©gala aqu√≠</li>
                            <li>¬°Debes estar transmitiendo EN VIVO!</li>
                        </ol>
                    </li>
                    <li><strong>TikTok:</strong> 
                        <ul style="margin-left: 20px; margin-top: 5px;">
                            <li>‚úÖ Solo necesitas tu username (sin @)</li>
                            <li>‚úÖ Usa TikFinity para conexi√≥n estable</li>
                            <li>‚úÖ Debes estar EN VIVO</li>
                        </ul>
                    </li>
                    <li><strong>Twitch:</strong> 
                        <ul style="margin-left: 20px; margin-top: 5px;">
                            <li>‚úÖ Solo necesitas tu nombre de canal (sin @)</li>
                            <li>‚úÖ Conexi√≥n directa v√≠a IRC WebSocket</li>
                            <li>‚úÖ Funciona est√©s en vivo o no</li>
                        </ul>
                    </li>
                    <li><strong>Kick:</strong> 
                        <ul style="margin-left: 20px; margin-top: 5px;">
                            <li>‚úÖ Solo necesitas tu nombre de canal (sin @)</li>
                            <li>‚úÖ Conexi√≥n v√≠a API p√∫blica y Pusher</li>
                            <li>‚úÖ Funciona con canales activos</li>
                        </ul>
                    </li>
                    <li><strong>Bot√≥n "Todos":</strong> Conecta a todas las plataformas que tengan datos ingresados</li>
                    <li><strong>Reconexi√≥n autom√°tica:</strong> Si se desconecta, reintenta cada 5 segundos</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let isReading = false;
        let youtubeInterval = null;
        let tiktokInterval = null;
        let twitchWs = null;
        let kickWs = null;
        let messageQueue = [];
        let isSpeaking = false;
        let voices = [];

        // Elementos del DOM
        const elements = {
            youtubeKey: document.getElementById('youtubeKey'),
            tiktokKey: document.getElementById('tiktokKey'),
            twitchKey: document.getElementById('twitchKey'),
            kickKey: document.getElementById('kickKey'),
            voiceSelect: document.getElementById('voiceSelect'),
            volumeSlider: document.getElementById('volumeSlider'),
            speedSlider: document.getElementById('speedSlider'),
            pitchSlider: document.getElementById('pitchSlider'),
            volumeValue: document.getElementById('volumeValue'),
            speedValue: document.getElementById('speedValue'),
            pitchValue: document.getElementById('pitchValue'),
            filterBots: document.getElementById('filterBots'),
            playSound: document.getElementById('playSound'),
            showTimestamp: document.getElementById('showTimestamp'),
            btnYoutube: document.getElementById('btnYoutube'),
            btnTiktok: document.getElementById('btnTiktok'),
            btnTwitch: document.getElementById('btnTwitch'),
            btnKick: document.getElementById('btnKick'),
            btnBoth: document.getElementById('btnBoth'),
            btnStop: document.getElementById('btnStop'),
            btnTest: document.getElementById('btnTest'),
            chatContainer: document.getElementById('chatContainer'),
            status: document.getElementById('status')
        };

        // Inicializar voces
        function loadVoices() {
            voices = speechSynthesis.getVoices();
            elements.voiceSelect.innerHTML = '';
            
            const spanishVoices = voices.filter(v => v.lang.startsWith('es'));
            const otherVoices = voices.filter(v => !v.lang.startsWith('es'));
            
            if (spanishVoices.length > 0) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = 'Voces en Espa√±ol';
                spanishVoices.forEach((voice, index) => {
                    const option = document.createElement('option');
                    option.value = voices.indexOf(voice);
                    option.textContent = `${voice.name} (${voice.lang})`;
                    optgroup.appendChild(option);
                });
                elements.voiceSelect.appendChild(optgroup);
            }
            
            if (otherVoices.length > 0) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = 'Otras Voces';
                otherVoices.forEach((voice, index) => {
                    const option = document.createElement('option');
                    option.value = voices.indexOf(voice);
                    option.textContent = `${voice.name} (${voice.lang})`;
                    optgroup.appendChild(option);
                });
                elements.voiceSelect.appendChild(optgroup);
            }
        }

        // Cargar voces cuando est√©n disponibles
        speechSynthesis.onvoiceschanged = loadVoices;
        loadVoices();

        // Actualizar valores de sliders
        elements.volumeSlider.addEventListener('input', (e) => {
            elements.volumeValue.textContent = `${e.target.value}%`;
        });

        elements.speedSlider.addEventListener('input', (e) => {
            elements.speedValue.textContent = `${e.target.value}x`;
        });

        elements.pitchSlider.addEventListener('input', (e) => {
            elements.pitchValue.textContent = e.target.value;
        });

        // Funci√≥n para hablar
        function speak(text) {
            return new Promise((resolve) => {
                const utterance = new SpeechSynthesisUtterance(text);
                
                const voiceIndex = parseInt(elements.voiceSelect.value);
                if (voices[voiceIndex]) {
                    utterance.voice = voices[voiceIndex];
                }
                
                utterance.volume = elements.volumeSlider.value / 100;
                utterance.rate = parseFloat(elements.speedSlider.value);
                utterance.pitch = parseFloat(elements.pitchSlider.value);
                
                utterance.onend = () => {
                    isSpeaking = false;
                    processQueue();
                    resolve();
                };
                
                utterance.onerror = () => {
                    isSpeaking = false;
                    processQueue();
                    resolve();
                };
                
                isSpeaking = true;
                speechSynthesis.speak(utterance);
            });
        }

        // Procesar cola de mensajes
        function processQueue() {
            if (messageQueue.length > 0 && !isSpeaking) {
                const message = messageQueue.shift();
                speak(message);
            }
        }

        // Agregar mensaje a la cola
        function addToQueue(text) {
            messageQueue.push(text);
            if (!isSpeaking) {
                processQueue();
            }
        }

        // Agregar mensaje al chat
        function addChatMessage(platform, username, message) {
            const timestamp = new Date().toLocaleTimeString();
            const platformClass = platform.toLowerCase();
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message chat-${platformClass}`;
            
            let timeStr = elements.showTimestamp.checked ? `[${timestamp}] ` : '';
            
            messageDiv.innerHTML = `
                <div>
                    <span class="chat-platform">[${platform}]</span>
                    ${timeStr}
                    <span class="chat-username">${username}</span>
                </div>
                <div class="chat-text">${message}</div>
            `;
            
            elements.chatContainer.appendChild(messageDiv);
            elements.chatContainer.scrollTop = elements.chatContainer.scrollHeight;
            
            // Filtrar bots
            const isBot = /bot|nightbot|streamelements|moobot/i.test(username);
            if (elements.filterBots.checked && isBot) {
                return;
            }
            
            // Reproducir sonido
            if (elements.playSound.checked) {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBCx+zPDTgjMGGGS36+OZTgwOTKXh8LRkHAU2jdXwyXwqBSh4x/DY=');
                audio.volume = 0.3;
                audio.play().catch(() => {});
            }
            
            // Leer en voz alta
            const textToSpeak = `${username} dice: ${message}`;
            addToQueue(textToSpeak);
        }

        // Lectura REAL de YouTube
        async function startYoutubeReading() {
            const apiKey = elements.youtubeKey.value.trim();
            let liveChatId = null;
            let nextPageToken = null;
            let isLive = false;
            
            // Funci√≥n para obtener el stream activo
            async function getLiveStream() {
                try {
                    // Primero necesitamos obtener el liveBroadcast activo
                    const broadcastUrl = `https://www.googleapis.com/youtube/v3/liveBroadcasts?part=snippet,contentDetails&broadcastStatus=active&key=${apiKey}`;
                    
                    const response = await fetch(broadcastUrl);
                    const data = await response.json();
                    
                    if (data.error) {
                        addChatMessage('SISTEMA', 'ERROR', `YouTube Error: ${data.error.message}`);
                        stopReading();
                        return false;
                    }
                    
                    if (data.items && data.items.length > 0) {
                        liveChatId = data.items[0].snippet.liveChatId;
                        isLive = true;
                        addChatMessage('SISTEMA', 'YOUTUBE', '‚úÖ ¬°Est√°s EN VIVO! Conectado al chat');
                        return true;
                    } else {
                        isLive = false;
                        addChatMessage('SISTEMA', 'YOUTUBE', '‚ùå NO est√°s en vivo actualmente');
                        stopReading();
                        return false;
                    }
                } catch (error) {
                    addChatMessage('SISTEMA', 'ERROR', `Error al conectar con YouTube: ${error.message}`);
                    stopReading();
                    return false;
                }
            }
            
            // Funci√≥n para leer mensajes del chat
            async function readChatMessages() {
                if (!liveChatId || !isLive) return;
                
                try {
                    let url = `https://www.googleapis.com/youtube/v3/liveChat/messages?liveChatId=${liveChatId}&part=snippet,authorDetails&key=${apiKey}`;
                    
                    if (nextPageToken) {
                        url += `&pageToken=${nextPageToken}`;
                    }
                    
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data.error) {
                        addChatMessage('SISTEMA', 'ERROR', `Error: ${data.error.message}`);
                        return;
                    }
                    
                    if (data.items) {
                        data.items.forEach(item => {
                            const username = item.authorDetails.displayName;
                            const message = item.snippet.displayMessage;
                            addChatMessage('YOUTUBE', username, message);
                        });
                    }
                    
                    nextPageToken = data.nextPageToken;
                    
                    // Programar la siguiente lectura seg√∫n el pollingIntervalMillis
                    const pollInterval = data.pollingIntervalMillis || 5000;
                    youtubeInterval = setTimeout(readChatMessages, pollInterval);
                    
                } catch (error) {
                    addChatMessage('SISTEMA', 'ERROR', `Error al leer mensajes: ${error.message}`);
                }
            }
            
            // Iniciar el proceso
            const connected = await getLiveStream();
            if (connected) {
                readChatMessages();
            }
        }

        // Lectura REAL de Twitch usando TMI.js (API de IRC)
        async function startTwitchReading() {
            const channel = elements.twitchKey.value.trim().toLowerCase();
            
            addChatMessage('SISTEMA', 'TWITCH', 'üîÑ Conectando con Twitch...');
            
            try {
                // Usar WebSocket IRC de Twitch
                twitchWs = new WebSocket('wss://irc-ws.chat.twitch.tv:443');
                
                twitchWs.onopen = () => {
                    // Conectar de forma an√≥nima
                    twitchWs.send('NICK justinfan12345');
                    twitchWs.send('CAP REQ :twitch.tv/tags twitch.tv/commands');
                    twitchWs.send(`JOIN #${channel}`);
                };
                
                twitchWs.onmessage = (event) => {
                    const message = event.data;
                    
                    // Responder a PING
                    if (message.startsWith('PING')) {
                        twitchWs.send('PONG :tmi.twitch.tv');
                        return;
                    }
                    
                    // Procesar mensajes de chat
                    if (message.includes('PRIVMSG')) {
                        const userMatch = message.match(/display-name=([^;]+)/);
                        const textMatch = message.match(/PRIVMSG #\w+ :(.+)/);
                        
                        if (userMatch && textMatch) {
                            const username = userMatch[1];
                            const text = textMatch[1];
                            addChatMessage('TWITCH', username, text);
                        }
                    }
                    
                    // Confirmaci√≥n de conexi√≥n
                    if (message.includes('JOIN')) {
                        addChatMessage('SISTEMA', 'TWITCH', `‚úÖ Conectado al canal: ${channel}`);
                        elements.status.textContent = 'üü¢ Estado: Leyendo Twitch';
                        elements.status.className = 'status active';
                    }
                };
                
                twitchWs.onerror = (error) => {
                    console.error('Twitch WebSocket error:', error);
                    addChatMessage('SISTEMA', 'ERROR', 'Error al conectar con Twitch. Verifica el nombre del canal.');
                };
                
                twitchWs.onclose = () => {
                    addChatMessage('SISTEMA', 'TWITCH', '‚ö†Ô∏è Desconectado de Twitch');
                    if (isReading) {
                        setTimeout(() => {
                            if (isReading) {
                                addChatMessage('SISTEMA', 'TWITCH', 'üîÑ Reconectando...');
                                startTwitchReading();
                            }
                        }, 5000);
                    }
                };
                
            } catch (error) {
                addChatMessage('SISTEMA', 'ERROR', `Error: ${error.message}`);
            }
        }

        // Lectura REAL de Kick usando API p√∫blica
        async function startKickReading() {
            const channel = elements.kickKey.value.trim().toLowerCase();
            
            addChatMessage('SISTEMA', 'KICK', 'üîÑ Conectando con Kick...');
            
            try {
                // Primero verificar si el canal existe y est√° en vivo
                const channelUrl = `https://kick.com/api/v2/channels/${channel}`;
                
                const response = await fetch(channelUrl);
                if (!response.ok) {
                    throw new Error('Canal no encontrado');
                }
                
                const channelData = await response.json();
                const chatroomId = channelData.chatroom?.id;
                
                if (!chatroomId) {
                    addChatMessage('SISTEMA', 'KICK', '‚ùå No se pudo obtener el ID del chat');
                    return;
                }
                
                addChatMessage('SISTEMA', 'KICK', `‚úÖ Conectado al canal: ${channel}`);
                
                // Conectar con Pusher (websocket de Kick)
                const pusherKey = 'eb1d5f283081a78b932c';
                kickWs = new WebSocket(`wss://ws-us2.pusher.com/app/${pusherKey}?protocol=7&client=js&version=7.0.3&flash=false`);
                
                kickWs.onopen = () => {
                    // Suscribirse al canal de chat
                    const subscribeMsg = JSON.stringify({
                        event: 'pusher:subscribe',
                        data: {
                            auth: '',
                            channel: `chatrooms.${chatroomId}.v2`
                        }
                    });
                    kickWs.send(subscribeMsg);
                    
                    addChatMessage('SISTEMA', 'KICK', '‚úÖ Conectado al chat de Kick');
                    elements.status.textContent = 'üü¢ Estado: Leyendo Kick';
                    elements.status.className = 'status active';
                };
                
                kickWs.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        
                        // Responder a ping
                        if (data.event === 'pusher:ping') {
                            kickWs.send(JSON.stringify({ event: 'pusher:pong', data: {} }));
                            return;
                        }
                        
                        // Procesar mensajes de chat
                        if (data.event === 'App\\Events\\ChatMessageEvent') {
                            const messageData = JSON.parse(data.data);
                            const username = messageData.sender?.username || 'Usuario';
                            const message = messageData.content || '';
                            
                            if (message) {
                                addChatMessage('KICK', username, message);
                            }
                        }
                        
                    } catch (e) {
                        console.error('Error procesando mensaje de Kick:', e);
                    }
                };
                
                kickWs.onerror = (error) => {
                    console.error('Kick WebSocket error:', error);
                    addChatMessage('SISTEMA', 'ERROR', 'Error al conectar con Kick');
                };
                
                kickWs.onclose = () => {
                    addChatMessage('SISTEMA', 'KICK', '‚ö†Ô∏è Desconectado de Kick');
                    if (isReading) {
                        setTimeout(() => {
                            if (isReading) {
                                addChatMessage('SISTEMA', 'KICK', 'üîÑ Reconectando...');
                                startKickReading();
                            }
                        }, 5000);
                    }
                };
                
            } catch (error) {
                addChatMessage('SISTEMA', 'ERROR', `Error: ${error.message}`);
            }
        }
        async function startTiktokReading() {
            const username = elements.tiktokKey.value.trim();
            let ws = null;
            
            addChatMessage('SISTEMA', 'TIKTOK', 'üîÑ Conectando con TikFinity...');
            
            try {
                // Conectar con la API p√∫blica de TikFinity
                const apiUrl = `https://tiktok.eulerstream.com/@${username}`;
                
                addChatMessage('SISTEMA', 'TIKTOK', `üîç Verificando si @${username} est√° en vivo...`);
                
                // Crear conexi√≥n WebSocket con TikFinity
                ws = new WebSocket(apiUrl);
                
                ws.onopen = () => {
                    addChatMessage('SISTEMA', 'TIKTOK', '‚úÖ ¬°Conectado a TikTok Live!');
                    elements.status.textContent = 'üü¢ Estado: Leyendo TikTok en vivo';
                    elements.status.className = 'status active';
                };
                
                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        
                        // Mensaje de chat
                        if (data.type === 'chat' || data.event === 'chat') {
                            const user = data.nickname || data.uniqueId || data.username || 'Usuario';
                            const message = data.comment || data.message || data.text || '';
                            
                            if (message) {
                                addChatMessage('TIKTOK', user, message);
                            }
                        }
                        
                        // Usuario se uni√≥
                        else if (data.type === 'member' || data.event === 'member') {
                            const user = data.nickname || data.uniqueId || 'Usuario';
                            addChatMessage('TIKTOK', user, 'üëã Se uni√≥ al stream');
                        }
                        
                        // Regalo
                        else if (data.type === 'gift' || data.event === 'gift') {
                            const user = data.nickname || data.uniqueId || 'Usuario';
                            const giftName = data.giftName || 'un regalo';
                            const count = data.repeatCount || 1;
                            addChatMessage('TIKTOK', user, `üéÅ Envi√≥ ${count}x ${giftName}`);
                        }
                        
                        // Like
                        else if (data.type === 'like' || data.event === 'like') {
                            const user = data.nickname || data.uniqueId || 'Usuario';
                            const likes = data.likeCount || 1;
                            if (likes > 10) { // Solo anunciar likes m√∫ltiples
                                addChatMessage('TIKTOK', user, `‚ù§Ô∏è Dio ${likes} likes`);
                            }
                        }
                        
                        // Follow
                        else if (data.type === 'follow' || data.event === 'follow') {
                            const user = data.nickname || data.uniqueId || 'Usuario';
                            addChatMessage('TIKTOK', user, '‚≠ê ¬°Te est√° siguiendo!');
                        }
                        
                        // Share
                        else if (data.type === 'share' || data.event === 'share') {
                            const user = data.nickname || data.uniqueId || 'Usuario';
                            addChatMessage('TIKTOK', user, 'üîÑ Comparti√≥ el stream');
                        }
                        
                        // Stream terminado
                        else if (data.type === 'streamEnd' || data.event === 'streamEnd') {
                            addChatMessage('SISTEMA', 'TIKTOK', 'üî¥ El stream ha terminado');
                            ws.close();
                            stopReading();
                        }
                        
                    } catch (e) {
                        console.error('Error procesando mensaje:', e);
                    }
                };
                
                ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    addChatMessage('SISTEMA', 'ERROR', 'Error en la conexi√≥n. Verifica que el usuario est√© en vivo.');
                    stopReading();
                };
                
                ws.onclose = () => {
                    addChatMessage('SISTEMA', 'TIKTOK', '‚ö†Ô∏è Desconectado de TikTok');
                    if (isReading) {
                        // Intentar reconectar
                        setTimeout(() => {
                            if (isReading) {
                                addChatMessage('SISTEMA', 'TIKTOK', 'üîÑ Intentando reconectar...');
                                startTiktokReading();
                            }
                        }, 5000);
                    }
                };
                
                // Guardar referencia al WebSocket
                window.tiktokWs = ws;
                
            } catch (error) {
                addChatMessage('SISTEMA', 'ERROR', `Error al conectar con TikTok: ${error.message}`);
                addChatMessage('SISTEMA', 'TIKTOK', '‚ÑπÔ∏è Aseg√∫rate de ingresar solo el nombre de usuario (sin @)');
                stopReading();
            }
        }

        // Iniciar lectura
        async function startReading(platform) {
            if (isReading) {
                alert('Ya hay una lectura en progreso');
                return;
            }
            
            // Validar API Keys
            if (platform === 'youtube' || platform === 'both') {
                if (!elements.youtubeKey.value.trim()) {
                    alert('Por favor ingresa tu YouTube API Key\n\nPasos:\n1. Ve a console.cloud.google.com\n2. Crea un proyecto\n3. Habilita YouTube Data API v3\n4. Crea credenciales (API Key)');
                    return;
                }
            }
            
            if (platform === 'tiktok' || platform === 'both') {
                if (!elements.tiktokKey.value.trim()) {
                    alert('Por favor ingresa tu nombre de usuario de TikTok (sin el @)\n\nEjemplo: si tu usuario es @juan123, ingresa solo: juan123');
                    return;
                }
            }
            
            isReading = true;
            elements.btnYoutube.disabled = true;
            elements.btnTiktok.disabled = true;
            elements.btnBoth.disabled = true;
            elements.btnStop.disabled = false;
            
            elements.chatContainer.innerHTML = '';
            
            if (platform === 'youtube' || platform === 'both') {
                elements.status.textContent = 'üü° Estado: Verificando YouTube...';
                elements.status.className = 'status active';
                addChatMessage('SISTEMA', 'SISTEMA', 'Verificando estado de YouTube...');
                await startYoutubeReading();
            }
            
            if (platform === 'tiktok' || platform === 'both') {
                elements.status.textContent = 'üü° Estado: Verificando TikTok...';
                elements.status.className = 'status active';
                addChatMessage('SISTEMA', 'SISTEMA', 'Verificando estado de TikTok...');
                await startTiktokReading();
            }
        }

        // Detener lectura
        function stopReading() {
            isReading = false;
            
            if (youtubeInterval) {
                clearTimeout(youtubeInterval);
                youtubeInterval = null;
            }
            
            if (window.tiktokWs) {
                window.tiktokWs.close();
                window.tiktokWs = null;
            }
            
            if (twitchWs) {
                twitchWs.close();
                twitchWs = null;
            }
            
            if (kickWs) {
                kickWs.close();
                kickWs = null;
            }
            
            speechSynthesis.cancel();
            messageQueue = [];
            
            elements.btnYoutube.disabled = false;
            elements.btnTiktok.disabled = false;
            elements.btnTwitch.disabled = false;
            elements.btnKick.disabled = false;
            elements.btnBoth.disabled = false;
            elements.btnStop.disabled = true;
            
            elements.status.textContent = 'üî¥ Estado: Detenido';
            elements.status.className = 'status';
            
            addChatMessage('SISTEMA', 'SISTEMA', 'Lectura detenida');
        }

        // Event Listeners
        elements.btnYoutube.addEventListener('click', () => startReading('youtube'));
        elements.btnTiktok.addEventListener('click', () => startReading('tiktok'));
        elements.btnTwitch.addEventListener('click', () => startReading('twitch'));
        elements.btnKick.addEventListener('click', () => startReading('kick'));
        elements.btnBoth.addEventListener('click', () => startReading('all'));
        elements.btnStop.addEventListener('click', stopReading);
        elements.btnTest.addEventListener('click', () => {
            speak('¬°Hola! Esta es una prueba de voz. El sistema est√° funcionando correctamente.');
        });

        // Limpiar al cerrar
        window.addEventListener('beforeunload', () => {
            stopReading();
        });
    </script>
</body>
</html>
