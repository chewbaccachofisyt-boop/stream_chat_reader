<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-scale, initial-scale=1.0">
    <title>Stream Chat Reader - TTS Web</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .chat-container {
            background: #1e1e1e;
            border-radius: 15px;
            padding: 20px;
            height: 400px;
            overflow-y: auto;
            color: #fff;
            font-family: monospace;
        }
        .chat-message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-left: 4px solid #667eea;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }
        .chat-youtube { border-left-color: #FF0000; }
        .chat-tiktok { border-left-color: #00f2ea; }
        .btn {
            padding: 15px 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            color: white;
            font-weight: bold;
            margin: 5px;
        }
        .btn-youtube { background: #FF0000; }
        .btn-tiktok { background: #000; }
        .btn-both { background: #10b981; }
        .btn-stop { background: #ef4444; }
    </style>
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üéôÔ∏è Stream Chat Reader</h1>
        <p>Lee tus chats de YouTube y TikTok en voz alta mientras juegas</p>
    </div>
    <div style="padding:20px;">
        <label>YouTube API Key:</label><br>
        <input id="youtubeKey" placeholder="Tu API Key" style="width:100%;padding:10px;margin-bottom:10px;"><br>
        <label>TikTok Username:</label><br>
        <input id="tiktokUser" placeholder="Tu usuario de TikTok" style="width:100%;padding:10px;margin-bottom:20px;"><br>

        <button class="btn btn-youtube" id="btnYoutube">‚ñ∂Ô∏è Iniciar YouTube</button>
        <button class="btn btn-tiktok" id="btnTiktok">‚ñ∂Ô∏è Iniciar TikTok</button>
        <button class="btn btn-both" id="btnBoth">‚ñ∂Ô∏è Iniciar Ambos</button>
        <button class="btn btn-stop" id="btnStop">‚èπÔ∏è Detener</button>

        <div id="chatContainer" class="chat-container" style="margin-top:20px;"></div>
    </div>
</div>

<script>
let youtubeInterval = null;
let messageQueue = [];
let isSpeaking = false;

// --- VOZ ---
function speak(text) {
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.rate = 1;
    utterance.pitch = 1;
    utterance.volume = 1;
    isSpeaking = true;
    utterance.onend = () => { isSpeaking = false; processQueue(); };
    speechSynthesis.speak(utterance);
}
function addToQueue(text){ messageQueue.push(text); if(!isSpeaking) processQueue(); }
function processQueue(){ if(messageQueue.length>0 && !isSpeaking) speak(messageQueue.shift()); }

// --- CHAT VISUAL ---
function addChatMessage(platform, username, message){
    const div = document.createElement('div');
    div.className = `chat-message chat-${platform.toLowerCase()}`;
    div.innerHTML = `<b>[${platform}] ${username}</b>: ${message}`;
    const container = document.getElementById('chatContainer');
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
    if (platform !== 'SISTEMA') addToQueue(`${username} dice: ${message}`);
}

// --- YOUTUBE ---
async function startYouTube(){
    const apiKey = document.getElementById('youtubeKey').value.trim();
    if(!apiKey){ alert('Falta la API Key de YouTube'); return; }
    addChatMessage('SISTEMA','YouTube','Conectando al chat...');
    try{
        const broadcastUrl = `https://www.googleapis.com/youtube/v3/liveBroadcasts?part=snippet&broadcastStatus=active&key=${apiKey}`;
        const res = await fetch(broadcastUrl);
        const data = await res.json();
        if(!data.items || data.items.length===0){ 
            addChatMessage('SISTEMA','YouTube','‚ùå No est√°s en vivo'); 
            return; 
        }
        const liveChatId = data.items[0].snippet.liveChatId;
        addChatMessage('SISTEMA','YouTube','‚úÖ Conectado al chat en vivo');
        async function fetchChat(){
            const chatUrl = `https://www.googleapis.com/youtube/v3/liveChat/messages?liveChatId=${liveChatId}&part=snippet,authorDetails&key=${apiKey}`;
            const r = await fetch(chatUrl); 
            const d = await r.json();
            if(d.items) d.items.forEach(i => 
                addChatMessage('YouTube', i.authorDetails.displayName, i.snippet.displayMessage)
            );
            youtubeInterval = setTimeout(fetchChat, (d.pollingIntervalMillis||5000));
        }
        fetchChat();
    }catch(e){ addChatMessage('SISTEMA','ERROR',e.message); }
}

// --- TIKTOK ---
async function startTikTok(){
    const username = document.getElementById('tiktokUser').value.trim();
    if(!username){ alert('Falta el usuario de TikTok'); return; }

    addChatMessage('SISTEMA','TikTok','Verificando estado en vivo...');
    try{
        // 1Ô∏è‚É£ Verificar si est√° en vivo
        const res = await fetch('https://tiktok-chat-server.onrender.com/api/check-live', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({username})
        });
        const data = await res.json();

        if(data.isLive){
            addChatMessage('SISTEMA','TikTok','‚úÖ Usuario est√° en vivo, iniciando conexi√≥n...');
            
            // 2Ô∏è‚É£ Iniciar la conexi√≥n en el backend
            await fetch('https://tiktok-chat-server.onrender.com/api/start-chat', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({username})
            });

            // 3Ô∏è‚É£ Escuchar eventos desde Socket.IO
            const socket = io('https://tiktok-chat-server.onrender.com', {
                transports: ['websocket', 'polling']
            });

            socket.on('connect', () => {
                addChatMessage('SISTEMA', 'TikTok', 'üü¢ Conectado al servidor WebSocket');
            });

            socket.on('tiktok-message', (msg) => {
                addChatMessage('TikTok', msg.username || msg.nickname || 'usuario', msg.message || msg.comment || '');
            });

            socket.on('tiktok-join', (msg) => {
                addChatMessage('TikTok', msg.username || 'usuario', 'üëã se uni√≥ al stream');
            });

            socket.on('tiktok-like', (msg) => {
                addChatMessage('TikTok', msg.username || 'usuario', `‚ù§Ô∏è dio ${msg.likeCount} likes`);
            });

            socket.on('tiktok-gift', (msg) => {
                addChatMessage('TikTok', msg.username || 'usuario', `üéÅ envi√≥ ${msg.giftCount}x ${msg.giftName}`);
            });

            socket.on('disconnect', () => {
                addChatMessage('SISTEMA', 'TikTok', 'üî¥ Desconectado del servidor');
            });
        } else {
            addChatMessage('SISTEMA','TikTok','‚ùå No est√° en vivo');
        }
    }catch(err){
        addChatMessage('SISTEMA','ERROR',err.message);
    }
}

// --- DETENER ---
function stopAll(){
    if(youtubeInterval) clearTimeout(youtubeInterval);
    youtubeInterval=null; speechSynthesis.cancel();
    document.getElementById('chatContainer').innerHTML='';
    addChatMessage('SISTEMA','SISTEMA','‚èπÔ∏è Lectura detenida');
}

// --- EVENTOS BOTONES ---
document.getElementById('btnYoutube').onclick=startYouTube;
document.getElementById('btnTiktok').onclick=startTikTok;
document.getElementById('btnBoth').onclick=()=>{ startYouTube(); startTikTok(); };
document.getElementById('btnStop').onclick=stopAll;
</script>
</body>
</html>
